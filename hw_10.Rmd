---
title: "Homework 10"
author: "Rob McNeil"
date: "2024-11-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


In this assignment I'm going to use to look at datasets from gapminder dealing with Total Fertility Rate, Life Expectancy, and Population. I'm interested in looking at TFR's association with life expectancy. Im going to perform some data wrangling on the three data sets and use ggplot2 and gganimate to answer test following hypothesis: 

Null hypothesis: changes in total fertility rate from 1952 to 2007 are associated with no changes in life expectancy 

Alternative hypothesis: changes in total fertility rate from  1952 to 2007 are associated with changes in life expectancy 

```{r,warning=FALSE,message=FALSE}
library(readr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(gganimate)
library(countrycode)
library(magick)
library(gifski)

#read fertility dataset and life expectancy dataset in from gapminder
#Linux Pathway 
fertility <- read.csv("/home/robmcneil/Documents/advanced_data/children_per_woman_total_fertility.csv")
life_expectancy <-read.csv("/home/robmcneil/Documents/advanced_data/lex.csv")
population <- read.csv("/home/robmcneil/Documents/advanced_data/pop.csv")

#Windows Pathway 

#fertility <-read.csv("C:/Users/rrm10/OneDrive/Desktop/R_MD/children_per_woman_total_fertility.csv")
#life_expectancy <-read.csv("C:/Users/rrm10/OneDrive/Desktop/R_MD/lex.csv")
#population <- read.csv("C:/Users/rrm10/OneDrive/Desktop/R_MD/pop.csv")

#read in with 'X' prefixing each column name. use gsub function to replace X in stings with blank space
colnames(fertility) <- gsub("^X", "", colnames(fertility))
colnames(life_expectancy) <- gsub("X", "", colnames(life_expectancy))
colnames(population)<-gsub("X", "",colnames(population))
head(fertility)
head(life_expectancy)

```

Transform data sets from wide format to long format to make them easier to use 
pivot_longer(data, cols, names_to = "name",
values_to = "value", values_drop_na = FALSE)



```{r,message=FALSE,warning=FALSE}

fertility_long <- fertility |>
  pivot_longer(cols = -country, names_to = 'year', values_to = 'fertility_rate', values_drop_na = TRUE)

life_expectancy_long <- life_expectancy |>
  pivot_longer(cols = -country, names_to = 'year', values_to = 'life_expectancy',
               values_drop_na = TRUE)

population_long <- population |>
  pivot_longer(cols = -country, names_to= 'year', values_to = 'population',
               values_drop_na = TRUE)|>
  mutate(population = gsub("M", "",population),
         population = as.numeric(population)*1e6)

#data quality checks pulls some warnings, due to NA values in 2100 or future years

#max(fertility_long$year)
#max(life_expectancy_long$year)
#unique(fertility_long$year)
#unique(life_expectancy_long$year)
```

```{r,warning=FALSE,message=FALSE}



#convert year to numeric 

fertility_long$year<-as.numeric(fertility_long$year)
life_expectancy_long$year<-as.numeric(life_expectancy_long$year)
population_long$year<-as.numeric(population_long$year)

#create year sequence object for filtering

year_sequence <- seq(1952,2007, by=5)

fertility_long <- fertility_long|>
  filter((year) %in% year_sequence)
  

life_expectancy_long <-life_expectancy_long |>
  filter((year) %in% year_sequence)

population_long <- population_long |>
  filter((year)%in% year_sequence)

min(fertility_long$year)
max(fertility_long$year)


```

data quality check
```{r,warning=FALSE,message=FALSE}
# Check unique countries in both data frames
unique_countries_fertility <- unique(fertility_long$country)
unique_countries_life_expectancy <- unique(life_expectancy_long$country)
unique_countries_population <- unique(population_long$country)
unique_countries_fertility
unique_countries_life_expectancy
unique_countries_population

#returns 197,197, and 195

# Find countries in fertility_long but not in life_expectancy_long
missing_in_life_expectancy <- setdiff(unique_countries_fertility, unique_countries_life_expectancy)

# Find countries in life_expectancy_long but not in fertility_long
missing_in_fertility <- setdiff(unique_countries_life_expectancy, unique_countries_fertility)

#find countries in population_long but not in fertility_long
missing_in_population <-setdiff(unique_countries_fertility,unique_countries_population)

# Print the results to check
#print(paste("Countries in fertility_long but not in life_expectancy_long:", #length(missing_in_life_expectancy)))
#print(paste("Countries in life_expectancy_long but not in fertility_long:", length(missing_in_fertility)))
#print(paste("Countries in population but not in fertility:",
            #length(missing_in_population)))

# Find the country in fertility_long but not in life_expectancy_long
missing_country <- missing_in_life_expectancy
#print(missing_country)

#returns 'Holy See' - I'm going to go ahead and leave this in 

```


Join tables 
```{r, message=FALSE,warning=FALSE}

fertility_life_expectancy <- inner_join(fertility_long,life_expectancy_long, by= c('country','year'))
fertility_life_expectancy <-inner_join(fertility_life_expectancy,population_long, by =c('country','year'))


#head(fertility_life_expectancy)

#unique(fertility_life_expectancy$country)

#use countrycode package to add a continent column

fertility_life_expectancy$continent <- countrycode(fertility_life_expectancy$country,
                                                   origin = 'country.name',
                                                   destination = 'continent')
#missing values, min/max
#colSums(is.na(fertility_life_expectancy))
#min(fertility_life_expectancy$life_expectancy)
#max(fertility_life_expectancy$life_expectancy)
#min(fertility_life_expectancy$population)
#max(fertility_life_expectancy$population)
#min(fertility_life_expectancy$year)
#max(fertility_life_expectancy$year)

#remove missing values 
fertility_life_expectancy <- fertility_life_expectancy |>
  filter(!is.na(population))|>
  filter(life_expectancy>0)

```

Hypothesis testing with data visualization. Our initial plot appears to show a linear relationship between life expectancy and total fertility rate, with countries with lower fertility rates having higher life expectancies. Inclusion of an animation allows us to see how the relationship for individual countries (color coded by continent) changes over time, confirming my alternate hypothesis that countries that experience lower total fertility rate have increasing life expectancies between 1952 and 2007. Thus, I can reject the null hypothesis in favor of my alternative based on these results.  


```{r,  message=FALSE,warning=FALSE}



#create labels of top ten countries:
top_fifteen <- fertility_life_expectancy |>
  group_by(country)|>
  summarize(delta=max(life_expectancy) - min(life_expectancy)) |>
  arrange(desc(delta))|>
  top_n(15)|>
  pull(country)

top_fifteen


#create a plot using ggplot2

plot <- ggplot(fertility_life_expectancy,
               aes(x= fertility_rate, y=life_expectancy,size=population, color=continent ))+
  geom_point(alpha = 0.7, show.legend = TRUE) + 
  geom_text(aes(label = ifelse(country %in% top_fifteen, country, '')), show.legend = FALSE) +
  scale_x_log10()+
  scale_size(range = c(2,12))+
  scale_colour_viridis_d() + 
  labs(x= 'Fertility Rate Per Country', y= 'Life Expectancy')

plot

plot + transition_time(year) + labs(title = "Year:{frame_time}")

```





