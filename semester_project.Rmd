---
title: "Semester_Project"
author: "Rob McNeil"
date: "2024-11-26"
output: html_document
---

#assess type_ and facility_type for missingness
#aggregate: create subgroups so you have 2 or three types
#how do I handle types that use both bup and nax? For geospatial, you can decide what you want to investiate
#can make 4 groups, no, 1, other, both, can compare in terms of how they are spatially distributed
#go to the hackathon meetings on monday
#base R subsetting 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r, message=FALSE, warning=FALSE}

library(spatstat)
SAMSHA <-read.csv("C:/Users/rrm10/Downloads/SAMHSA.csv")

#api key: 93ad8b2e-920b-4037-8f94-97ec41ee397d

```

```{r,warning=FALSE}

#str(SAMSHA)


#explore missingness between Type_ and Facility_Type 

unique(SAMSHA$Type_)
unique(SAMSHA$Facility_Type)

length(SAMSHA$Type_)
length(SAMSHA$Facility_Type)

sum(is.na(SAMSHA$Type_))
sum(is.na(SAMSHA$Facility_Type))

#neither column has missingness, I think I'm going to use Facility_Type because it will be easier for me to stratify

```




```{r, warning=FALSE,message=FALSE}

#provide range in how we want to consider obervations
bbx<- owin(xrange = range(SAMSHA$LONGITUDE), yrange = range(SAMSHA$LATITUDE))
#planar point pattern: specify 2 coloumns in dataset that represent geo-spatial dimensions, store it in object X
X <- ppp(SAMSHA$LONGITUDE, SAMSHA$LATITUDE, window = bbx)
#warning (data contains duplicated points)
X
plot(X)
# create basic visualization, can see density follows front range

# Get the number of rows in SAMSHA dataset
n <- dim(SAMSHA)[1]  # Get number of rows (observations)

# Initialize a vector to store facility type marks, initially set to 0
fmv <- rep(0, n)

#use regular expression to stratify mental health facility 
tmp <-grep("psychiatric|mental",SAMSHA$Facility_Type, ignore.case=TRUE)
#wmp <-grep("residential", SAMSHA$Facility_type, ignore.case=TRUE)

fmv[tmp]<-1

fmv1<- factor(fmv,levels = c(0,1), labels = c("General Facility", "Psychiatric Facility"))

X.m <- ppp(SAMSHA$LONGITUDE,SAMSHA$LATITUDE,window=bbx,marks = fmv1)
plot(X.m)

tmp<-grep("residential", SAMSHA$Facility_Type, ignore.case=TRUE)
fmv[tmp]<-2
fmv2 <-factor(fmv)
X.m2 <- ppp(SAMSHA$LONGITUDE,SAMSHA$LATITUDE,window=bbx,marks=fmv2)
plot(X.m2)

#looks like a facility contains both? 


```



Statistical Inference using K function 
```{r, warning=FALSE}
estK <-Kest(X)
plot(estK)
#question at 20 minutes should I be making seperate vectors for each>
#this method doesnt consider marks, only considers distrobution of datapints (27:00)
#null hypothesis assumes a complete spatial randomness
#why do I get 4 lines? 

swb<-rescale(X)
kvb<-varblock(swb,Kest,nx=8,ny=8) #bootstrap function utilizing binning 
plot(kvb)

kvl <-lohboot(swb,Kest)    #confidence intervals, runs many simulations. more sophisticated
plot(kvl)


E <- envelope(swb,Kest)  #summary of simulation
E




```
other method based on stratification of different marks at 44:00

```{r, warning=FALSE}

probH <-relrisk(X.m2,diggle=T) #non-parametric test estimating relative risk
plot(probH)
#consider increasing to 100 or 200 for semester project
segregation.test(X.m2,nsim=200,hmin=0.05,hmax=5)

#am I using this correctly with a stratified into 3 


```







```{r}



library(ggplot2)

register_stadiamaps(key = "93ad8b2e-920b-4037-8f94-97ec41ee397d")

# Step 1: Extract coordinates and facility types from X.m2
coords_df <- data.frame(
  Longitude = X.m2$x,  # Longitude values from X.m2
  Latitude = X.m2$y,   # Latitude values from X.m2
  Facility_Type = factor(X.m2$marks, levels = c("0", "1", "2"), 
                         labels = c("General Facility", "Psychiatric Facility", "Residential Facility"))
)

# Step 2: Get the basemap (adjust zoom if needed)
colo_map <- get_stadiamap(colo, zoom = 7, maptype = "stamen_terrain") |> ggmap()

# Step 3: Create the map with ggplot2, overlaying the points
colo_map + 
  geom_point(aes(x = Longitude, y = Latitude, color = Facility_Type), data = coords_df, size = 3) +
  scale_color_manual(values = c("General Facility" = "blue", "Psychiatric Facility" = "red", "Residential Facility" = "green")) +
  theme_minimal() +
  labs(title = "Mental Health Facility Distribution",
       subtitle = "Facilities marked by type (General, Psychiatric, Residential)",
       x = "Longitude", y = "Latitude")






```




Question 2: Are spatial distribuions of behavioral health treatment service providers throughout Colorado different based on whether Naltrexone or buprenorphine is used in treatment> 




```{r, warning=FALSE}

# create dummy variables for Naltrexone or buprenorphine 

SAMSHA$Naltrexone_used <- ifelse(SAMSHA$Naltrexone_used_in_Treatment == "Naltrexone used in Treatment", 1, 0)
SAMSHA$Buprenorphine_used <- ifelse(SAMSHA$Buprenorphine_used_in_Treatment == "Buprenorphine used in Treatment", 1,0)

#head(SAMSHA[, c("Naltrexone_used", "Buprenorphine_used")])

#proceeding with analysis:

X_naltrexone <- ppp(SAMSHA$LONGITUDE[SAMSHA$Naltrexone_used == 1], 
                    SAMSHA$LATITUDE[SAMSHA$Naltrexone_used == 1], window = bbx)
plot(X_naltrexone, main = "Spatial Distribution of Naltrexone Treatment Facilities")

X_buprenorphine <- ppp(SAMSHA$LONGITUDE[SAMSHA$Buprenorphine_used == 1], 
                       SAMSHA$LATITUDE[SAMSHA$Buprenorphine_used == 1], window = bbx)
plot(X_buprenorphine, main = "Spatial Distribution of Buprenorphine Treatment Facilities")


plot(X_naltrexone, main = "Spatial Distribution of Naltrexone and Buprenorphine Treatment Facilities", col= "blue")
points(X_buprenorphine, col = "red")
legend("topright", legend = c("Naltrexone", "Buprenorphine"), col = c("blue", "red"), pch = 16)



#spatial statistics

# K-function for Naltrexone
K_naltrexone <- Kest(X_naltrexone)
plot(K_naltrexone)

# K-function for Buprenorphine
K_buprenorphine <- Kest(X_buprenorphine)
plot(K_buprenorphine)

```
