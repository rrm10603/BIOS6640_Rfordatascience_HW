---
title: "Semester_Project"
author: "Rob McNeil"
date: "2024-11-26"
output: html_document
---

#assess type_ and facility_type for missingness
#aggregate: create subgroups so you have 2 or three types
#how do I handle types that use both bup and nax? For geospatial, you can decide what you want to investiate
#can make 4 groups, no, 1, other, both, can compare in terms of how they are spatially distributed
#go to the hackathon meetings on monday
#base R subsetting 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r, message=FALSE, warning=FALSE}

library(spatstat)
library(ggmap)
library(ggplot2)
SAMSHA <-read.csv("C:/Users/rrm10/Downloads/SAMHSA.csv")

#api key: 93ad8b2e-920b-4037-8f94-97ec41ee397d

```

```{r,warning=FALSE}

#str(SAMSHA)


#explore missingness between Type_ and Facility_Type 

unique(SAMSHA$Type_)
unique(SAMSHA$Facility_Type)

length(SAMSHA$Type_)
length(SAMSHA$Facility_Type)

sum(is.na(SAMSHA$Type_))
sum(is.na(SAMSHA$Facility_Type))

#neither column has missingness, I think I'm going to use Facility_Type because it will be easier for me to stratify

```




```{r, warning=FALSE,message=FALSE}

#provide range in how we want to consider obervations
bbx<- owin(xrange = range(SAMSHA$LONGITUDE), yrange = range(SAMSHA$LATITUDE))
#planar point pattern: specify 2 coloumns in dataset that represent geo-spatial dimensions, store it in object X
X <- ppp(SAMSHA$LONGITUDE, SAMSHA$LATITUDE, window = bbx)
#warning (data contains duplicated points)
X
plot(X)
# create basic visualization, can see density follows front range

# Get the number of rows in SAMSHA dataset
n <- dim(SAMSHA)[1]  # Get number of rows (observations)

# Initialize a vector to store facility type marks, initially set to 0
fmv <- rep(0, n)

#use regular expression to stratify mental health facility 
tmp <-grep("psychiatric|mental",SAMSHA$Facility_Type, ignore.case=TRUE)
#wmp <-grep("residential", SAMSHA$Facility_type, ignore.case=TRUE)

fmv[tmp]<-1

fmv1<- factor(fmv,levels = c(0,1), labels = c("General Facility", "Psychiatric Facility"))

X.m <- ppp(SAMSHA$LONGITUDE,SAMSHA$LATITUDE,window=bbx,marks = fmv1)
plot(X.m)

tmp<-grep("residential", SAMSHA$Facility_Type, ignore.case=TRUE)
fmv[tmp]<-2
fmv2 <-factor(fmv)
X.m2 <- ppp(SAMSHA$LONGITUDE,SAMSHA$LATITUDE,window=bbx,marks=fmv2)
plot(X.m2)

#looks like a facility contains both? 


```



Statistical Inference using K function 
```{r, warning=FALSE}
estK <-Kest(X)
plot(estK)
#question at 20 minutes should I be making seperate vectors for each>
#this method doesnt consider marks, only considers distrobution of datapints (27:00)
#null hypothesis assumes a complete spatial randomness
#why do I get 4 lines? 

swb<-rescale(X)
kvb<-varblock(swb,Kest,nx=8,ny=8) #bootstrap function utilizing binning 
plot(kvb)

kvl <-lohboot(swb,Kest)    #confidence intervals, runs many simulations. more sophisticated
plot(kvl)


E <- envelope(swb,Kest)  #summary of simulation
E




```
other method based on stratification of different marks at 44:00

```{r, warning=FALSE}

probH <-relrisk(X.m2,diggle=T) #non-parametric test estimating relative risk
plot(probH)
#consider increasing to 100 or 200 for semester project
segregation.test(X.m2,nsim=200,hmin=0.05,hmax=5)

#am I using this correctly with a stratified into 3 


```







```{r}





register_stadiamaps(key = "93ad8b2e-920b-4037-8f94-97ec41ee397d")

# Step 1: Extract coordinates and facility types from X.m2
coords_df <- data.frame(
  Longitude = X.m2$x,  # Longitude values from X.m2
  Latitude = X.m2$y,   # Latitude values from X.m2
  Facility_Type = factor(X.m2$marks, levels = c("0", "1", "2"), 
                         labels = c("General Facility", "Psychiatric Facility", "Residential Facility"))
)

# Step 2: Get the basemap (adjust zoom if needed)
colo <- c(left = -109, bottom = 37, right = -102, top = 41)
colo_map <- get_stadiamap(colo, zoom = 7, maptype = "stamen_terrain") |> ggmap()

# Step 3: Create the map with ggplot2, overlaying the points
colo_map + 
  geom_point(aes(x = Longitude, y = Latitude, color = Facility_Type), data = coords_df, size = 3) +
  scale_color_manual(values = c("General Facility" = "blue", "Psychiatric Facility" = "red", "Residential Facility" = "green")) +
  theme_minimal() +
  labs(title = "Mental Health Facility Distribution",
       subtitle = "Facilities marked by type (General, Psychiatric, Residential)",
       x = "Longitude", y = "Latitude")






```




Question 2: Are spatial distribuions of behavioral health treatment service providers throughout Colorado different based on whether Naltrexone or buprenorphine is used in treatment> 

```{r}

#exploring Opiod_Treatment_Settings 

unique(SAMSHA$Opiod_Treatment_Settings)
#Can see Naltrexone used in treatment, does not treat opiod additction 

table(SAMSHA$Opiod_Treatment_Settings, SAMSHA$Naltrexone_used_in_Treatment, SAMSHA$Buprenorphine_used_in_Treatment)

```


```{r, warning = FALSE}

# Create a new vector to store marks for Naltrexone/Buprenorphine usage
treatment_marks <- rep(0, n)

# Use regex to find rows where Naltrexone is used in treatment, excluding negative contexts
naltrexone_treatment <- grep("Naltrexone used in Treatment", SAMSHA$Opiod_Treatment_Settings, ignore.case = TRUE)  # Find Naltrexone mentions
negative_naltrexone <- grep("Does not treat opioid addiction|Do not use medication for opioid addiction", SAMSHA$Opiod_Treatment_Settings, ignore.case = TRUE)  # Find negative contexts for Naltrexone

# Remove cases where both Naltrexone and negative contexts are mentioned
valid_naltrexone <- setdiff(naltrexone_treatment, negative_naltrexone)
treatment_marks[valid_naltrexone] <- 1  # Mark Naltrexone

# Use regex to find rows where Buprenorphine is used in treatment, excluding negative contexts
buprenorphine_treatment <- grep("Buprenorphine used in Treatment", SAMSHA$Opiod_Treatment_Settings, ignore.case = TRUE)  # Find Buprenorphine mentions
negative_buprenorphine <- grep("Does not treat opioid addiction|Do not use medication for opioid addiction", SAMSHA$Opiod_Treatment_Settings, ignore.case = TRUE)  # Find negative contexts for Buprenorphine

# Remove cases where both Buprenorphine and negative contexts are mentioned
valid_buprenorphine <- setdiff(buprenorphine_treatment, negative_buprenorphine)
treatment_marks[valid_buprenorphine] <- 2  # Mark Buprenorphine

# Create a factor for Naltrexone/Buprenorphine treatments
treatment_factors <- factor(treatment_marks, levels = c(0, 1, 2), labels = c("No Medication", "Naltrexone", "Buprenorphine"))

# Store this in the point pattern object X.m
Y.m <- ppp(SAMSHA$LONGITUDE, SAMSHA$LATITUDE, window = bbx, marks = treatment_factors)

```



```{r, warning =FALSE}

#statistical inference
probI <- relrisk(Y.m, diggle = TRUE)  # Non-parametric test estimating relative risk
plot(probI)

segregation.test(Y.m, nsim = 200, hmin = 0.05, hmax = 5)

```


Data Visualization Using Smoothing clusters 
To understand the concentratio of facilities, density plot will highlight regions with higher densicy 

```{r}

#extract coordinates and treatment types from Y.m ppp object

coords_df_y <- data.frame(
  Longitude = Y.m$x,  # Longitude values from Y.m
  Latitude = Y.m$y,   # Latitude values from Y.m
  Facility_Type = factor(Y.m$marks, levels = c("No Medication", "Naltrexone", "Buprenorphine"))
)

#subset data by treatment type

# Subset the data by treatment type
coords_df_naltrexone <- coords_df[coords_df$Facility_Type == "Naltrexone", ]
coords_df_buprenorphine <- coords_df[coords_df$Facility_Type == "Buprenorphine", ]
coords_df_no_medication <- coords_df[coords_df$Facility_Type == "No Medication", ]


# Background map with density overlay
colo_map_background <- get_stadiamap(colo, zoom = 7, maptype = "stamen_toner_background") |> ggmap(darken = 0.7)

# Overlay density plot with fill
colo_map_background +
  stat_density_2d(aes(Longitude, Latitude, fill = ..level..), data = coords_df_y, geom = "polygon", alpha = 0.5) +
  scale_fill_gradient2("Facility Density", low = "white", mid = "yellow", high = "red") +
  theme(legend.position = "left") +
  labs(title = "Density Heatmap of Behavioral Health Facilities",
       subtitle = "Colored by Treatment Density (No Medication, Naltrexone, Buprenorphine)")



```




```{r}
# Extract coordinates and treatment types from Y.m
coords_df <- data.frame(
  Longitude = Y.m$x,  # Longitude values from Y.m
  Latitude = Y.m$y,   # Latitude values from Y.m
  Treatment_Type = factor(Y.m$marks, levels = c("No Medication", "Naltrexone", "Buprenorphine"))
)

# Background map with density overlay
colo_map_background <- get_stadiamap(colo, zoom = 7, maptype = "stamen_toner_background") |> ggmap(darken = 0.7)

# Plot density for Naltrexone
colo_map_background + 
  stat_density_2d(data = coords_df[coords_df$Treatment_Type == "Naltrexone", ], 
                  aes(x = Longitude, y = Latitude, fill = ..level..), 
                  geom = "polygon", alpha = 0.5) +
  scale_fill_gradient2("Density", low = "white", mid = "yellow", high = "red") +
  theme(legend.position = "left") +
  labs(title = "Density Heatmap of Naltrexone Treatment Facilities")

# Plot density for Buprenorphine
colo_map_background + 
  stat_density_2d(data = coords_df[coords_df$Treatment_Type == "Buprenorphine", ], 
                  aes(x = Longitude, y = Latitude, fill = ..level..), 
                  geom = "polygon", alpha = 0.5) +
  scale_fill_gradient2("Density", low = "white", mid = "yellow", high = "red") +
  theme(legend.position = "left") +
  labs(title = "Density Heatmap of Buprenorphine Treatment Facilities")

# Plot density for No Medication
colo_map_background + 
  stat_density_2d(data = coords_df[coords_df$Treatment_Type == "No Medication", ], 
                  aes(x = Longitude, y = Latitude, fill = ..level..), 
                  geom = "polygon", alpha = 0.5) +
  scale_fill_gradient2("Density", low = "white", mid = "yellow", high = "red") +
  theme(legend.position = "left") +
  labs(title = "Density Heatmap of No Medication Facilities")

```




```{r}

# Background map with density overlay
colo_map_background <- get_stadiamap(colo, zoom = 7, maptype = "stamen_toner_background") |> ggmap(darken = 0.7)

# Overlay density plots for each treatment type with treatment categories as colors
colo_map_background +
  geom_point(data = coords_df, 
             aes(x = Longitude, y = Latitude, color = Treatment_Type), 
             size = 3, alpha = 0.5) +
  scale_color_manual(values = c("No Medication" = "blue", 
                                "Naltrexone" = "red", 
                                "Buprenorphine" = "green")) +
  theme_minimal() +
  labs(title = "Mental Health Facility Distribution by Treatment Type",
       subtitle = "Colored by Treatment Type (Naltrexone, Buprenorphine, No Medication)",
       x = "Longitude", y = "Latitude")



```




Statistical inference
Stratified Point Pattern: Since Y.m has categorical marks (i.e., treatment types), you can perform the relative risk and segregation test in a stratified manner, as you've done with X.m2. In Y.m, the marks (Naltrexone, Buprenorphine, No Medication) represent different treatments, so you are comparing the spatial patterns of these three treatment types.

```{r}
probY <-relrisk(Y.m,diggle=T) #non-parametric test estimating relative risk
plot(probY)
#consider increasing to 100 or 200 for semester project
segregation.test(Y.m,nsim=200,hmin=0.05,hmax=5)

 



```
